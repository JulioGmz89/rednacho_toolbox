<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:views="clr-namespace:RedNachoToolbox.Views"
             xmlns:viewmodels="clr-namespace:RedNachoToolbox.ViewModels"
             xmlns:models="clr-namespace:RedNachoToolbox.Models"
             xmlns:controls="clr-namespace:Microsoft.Maui.Controls;assembly=Microsoft.Maui.Controls"
             x:Class="RedNachoToolbox.MainPage"
             x:Name="MainPageRoot"
             x:DataType="viewmodels:MainViewModel"
             Title=""
             Shell.BackgroundColor="{DynamicResource SidebarBackgroundColor}"
             Shell.NavBarHasShadow="False">

    <ContentPage.Resources>
        <!-- Interactive Button Frame Style with Hover and Active States -->
        <Style x:Key="InteractiveButtonFrame" TargetType="Frame">
            <Setter Property="BackgroundColor" Value="Transparent" />
            <Setter Property="BorderColor" Value="Transparent" />
            <Setter Property="HasShadow" Value="False" />
            <Setter Property="Padding" Value="0" />
            <Setter Property="HeightRequest" Value="48" />
            <Setter Property="HorizontalOptions" Value="Fill" />
        </Style>
        
        <!-- Active Button Frame Style with subtle background color -->
        <Style x:Key="ActiveButtonFrame" TargetType="Frame" BasedOn="{StaticResource InteractiveButtonFrame}">
            <Setter Property="BackgroundColor" Value="#1A2A5E" />
            <Setter Property="Opacity" Value="0.1" />
        </Style>
    </ContentPage.Resources>
    
    <Grid>
        <Grid.ColumnDefinitions>
            <ColumnDefinition Width="{Binding IsSidebarCollapsed, Converter={StaticResource BoolToWidthConverter}}" />
            <ColumnDefinition Width="*" />
        </Grid.ColumnDefinitions>

        <!-- Navigation Sidebar -->
        <Border Grid.Column="0"
                BackgroundColor="{DynamicResource SidebarBackgroundColor}"
                StrokeThickness="0">
            <Grid>
                <Grid.RowDefinitions>
                    <RowDefinition Height="*" />
                    <RowDefinition Height="Auto" />
                </Grid.RowDefinitions>
                
                <!-- Main Navigation Area -->
                <ScrollView Grid.Row="0">
                    <VerticalStackLayout Padding="{Binding IsSidebarCollapsed, Converter={StaticResource BoolToPaddingConverter}}" Spacing="16">
                        <!-- App Logo -->
                        <Image Source="{Binding LogoImageSource}"
                               Aspect="AspectFit"
                               HorizontalOptions="Center"
                               VerticalOptions="Start"
                               HeightRequest="{Binding IsSidebarCollapsed, Converter={StaticResource BoolToLogoHeightConverter}}"
                               Margin="0,8,0,16" />
                        
                        <!-- Collapsed Navigation Section (Visible only when collapsed) -->
                        <VerticalStackLayout Spacing="8" IsVisible="{Binding IsSidebarCollapsed}" Margin="0,0,0,16">
                            
                            <!-- Dashboard Button - Collapsed -->
                            <Grid HeightRequest="40" WidthRequest="40" HorizontalOptions="Center">
                                <Frame x:Name="DashboardButtonFrameCollapsed" 
                                       Style="{StaticResource InteractiveButtonFrame}" 
                                       HeightRequest="40" 
                                       WidthRequest="40" 
                                       CornerRadius="8">
                                    <Frame.GestureRecognizers>
                                        <TapGestureRecognizer Tapped="OnDashboardClicked" />
                                        <PointerGestureRecognizer PointerEntered="OnDashboardPointerEntered" 
                                                                PointerExited="OnDashboardPointerExited" />
                                    </Frame.GestureRecognizers>
                                    <Image WidthRequest="18"
                                           HeightRequest="18"
                                           VerticalOptions="Center"
                                           HorizontalOptions="Center">
                                        <Image.Source>
                                            <MultiBinding Converter="{StaticResource ThemeIconConverter}">
                                                <Binding Path="DashboardIconBase" />
                                                <Binding Path="IsDarkTheme" />
                                            </MultiBinding>
                                        </Image.Source>
                                    </Image>
                                </Frame>
                                
                                <!-- Active Page Indicator - Collapsed Dot -->
                                <Ellipse x:Name="DashboardIndicatorDotCollapsed"
                                         WidthRequest="8"
                                         HeightRequest="8"
                                         Fill="{DynamicResource PrimaryRed}"
                                         VerticalOptions="Start"
                                         HorizontalOptions="Start"
                                         Margin="4,4,0,0"
                                         IsVisible="{Binding IsDashboardActive}" />
                            </Grid>
                            
                            <!-- Divider between Dashboard and Productivity -->
                            <BoxView HeightRequest="1"
                                     BackgroundColor="{DynamicResource BorderColorLight}"
                                     Margin="8,4,8,4" />
                            
                            <!-- Productivity Button - Collapsed -->
                            <Grid HeightRequest="40" WidthRequest="40" HorizontalOptions="Center">
                                <Frame x:Name="ProductivityButtonFrameCollapsed" 
                                       Style="{StaticResource InteractiveButtonFrame}" 
                                       HeightRequest="40" 
                                       WidthRequest="40" 
                                       CornerRadius="8">
                                    <Frame.GestureRecognizers>
                                        <TapGestureRecognizer Tapped="OnProductivityClicked" />
                                        <PointerGestureRecognizer PointerEntered="OnProductivityPointerEntered" 
                                                                PointerExited="OnProductivityPointerExited" />
                                    </Frame.GestureRecognizers>
                                    <Image WidthRequest="18"
                                           HeightRequest="18"
                                           VerticalOptions="Center"
                                           HorizontalOptions="Center"
                                           Source="{AppThemeBinding Light=rocket_light.png, Dark=rocket_dark.png}" />
                                </Frame>
                                
                                <!-- Active Page Indicator - Collapsed Dot -->
                                <Ellipse x:Name="ProductivityIndicatorDotCollapsed"
                                         WidthRequest="8"
                                         HeightRequest="8"
                                         Fill="{DynamicResource PrimaryRed}"
                                         VerticalOptions="Start"
                                         HorizontalOptions="Start"
                                         Margin="4,4,0,0"
                                         IsVisible="{Binding IsProductivityActive}" />
                            </Grid>
                            
                        </VerticalStackLayout>
                        
                        <!-- Search Bar (temporarily disabled) -->
                        <!--
                        <SearchBar x:Name="ToolSearchBar"
                                   Placeholder="Search tools..."
                                   BackgroundColor="{DynamicResource InputBackgroundColor}"
                                   TextColor="{DynamicResource InputTextColor}"
                                   PlaceholderColor="{DynamicResource InputPlaceholderColor}"
                                   CancelButtonColor="{DynamicResource InteractivePrimaryColor}"
                                   SearchButtonPressed="OnSearchButtonPressed"
                                   TextChanged="OnSearchTextChanged"
                                   Margin="0,0,0,16"
                                   IsVisible="{Binding IsSidebarCollapsed, Converter={StaticResource InvertedBoolConverter}}" />
                        -->
                        
                        <!-- Navigation Section (Hidden when collapsed) -->
                        <VerticalStackLayout Spacing="8" IsVisible="{Binding IsSidebarCollapsed, Converter={StaticResource InvertedBoolConverter}}">
                            
                            <!-- Dashboard Button -->
                            <Frame x:Name="DashboardButtonFrame" Style="{StaticResource InteractiveButtonFrame}">
                                <Frame.GestureRecognizers>
                                    <TapGestureRecognizer Tapped="OnDashboardClicked" />
                                    <PointerGestureRecognizer PointerEntered="OnDashboardPointerEntered" 
                                                            PointerExited="OnDashboardPointerExited" />
                                </Frame.GestureRecognizers>
                                <Grid ColumnDefinitions="4, 28, *" ColumnSpacing="8" Padding="8,8">
                                    <!-- Active Page Indicator - Capsule Shape -->
                                    <Border x:Name="DashboardIndicatorCapsule"
                                            Grid.Column="0"
                                            WidthRequest="4"
                                            HeightRequest="20"
                                            BackgroundColor="{DynamicResource PrimaryRed}"
                                            VerticalOptions="Center"
                                            HorizontalOptions="Center"
                                            StrokeThickness="0"
                                            IsVisible="{Binding IsDashboardActive}">
                                        <Border.StrokeShape>
                                            <RoundRectangle CornerRadius="2" />
                                        </Border.StrokeShape>
                                    </Border>
                                    
                                    <Image Grid.Column="1"
                                           WidthRequest="20"
                                           HeightRequest="20"
                                           VerticalOptions="Center">
                                        <Image.Source>
                                            <MultiBinding Converter="{StaticResource ThemeIconConverter}">
                                                <Binding Path="DashboardIconBase" />
                                                <Binding Path="IsDarkTheme" />
                                            </MultiBinding>
                                        </Image.Source>
                                    </Image>
                                    <Label Grid.Column="2"
                                           Text="Dashboard"
                                           TextColor="{DynamicResource TextColor}"
                                           VerticalOptions="Center"
                                           HorizontalOptions="Start"
                                           FontSize="14" />
                                </Grid>
                            </Frame>
                            
                            <!-- Divider -->
                            <BoxView HeightRequest="1"
                                     BackgroundColor="{DynamicResource BorderColorLight}"
                                     Margin="8,8,8,8" />
                            
                            <!-- Productivity Button -->
                            <Frame x:Name="ProductivityButtonFrame" Style="{StaticResource InteractiveButtonFrame}" HeightRequest="56">
                                <Frame.GestureRecognizers>
                                    <TapGestureRecognizer Tapped="OnProductivityClicked" />
                                    <PointerGestureRecognizer PointerEntered="OnProductivityPointerEntered" 
                                                            PointerExited="OnProductivityPointerExited" />
                                </Frame.GestureRecognizers>
                                <Grid ColumnDefinitions="4, 28, *, 48" ColumnSpacing="8" Padding="10,10">
                                    <!-- Active Page Indicator - Capsule Shape -->
                                    <Border x:Name="ProductivityIndicatorCapsule"
                                            Grid.Column="0"
                                            WidthRequest="4"
                                            HeightRequest="20"
                                            BackgroundColor="{DynamicResource PrimaryRed}"
                                            VerticalOptions="Center"
                                            HorizontalOptions="Center"
                                            StrokeThickness="0"
                                            IsVisible="{Binding IsProductivityActive}">
                                        <Border.StrokeShape>
                                            <RoundRectangle CornerRadius="2" />
                                        </Border.StrokeShape>
                                    </Border>
                                    
                                    <Image Grid.Column="1"
                                           WidthRequest="20"
                                           HeightRequest="20"
                                           VerticalOptions="Center"
                                           Source="{AppThemeBinding Light=rocket_light.png, Dark=rocket_dark.png}" />
                                    <Label Grid.Column="2"
                                           Text="Productivity"
                                           TextColor="{DynamicResource TextColor}"
                                           VerticalOptions="Center"
                                           HorizontalOptions="Start"
                                           FontSize="14" />
                                    
                                    <!-- Chevron for expanding/collapsing the Productivity list -->
                                    <Grid x:Name="ProductivityChevronHitArea"
                                          Grid.Column="3"
                                          VerticalOptions="Center"
                                          HorizontalOptions="Fill">
                                        <Grid.GestureRecognizers>
                                            <TapGestureRecognizer Tapped="OnProductivityChevronTapped" />
                                        </Grid.GestureRecognizers>
                                        <Image x:Name="ProductivityChevronImage"
                                               WidthRequest="12"
                                               HeightRequest="12"
                                               VerticalOptions="Center"
                                               HorizontalOptions="End"
                                               Source="{AppThemeBinding Light=chevron_light.png, Dark=chevron_dark.png}" />
                                    </Grid>
                                </Grid>
                            </Frame>

                            <!-- Expanded list of Productivity tools (indented) -->
                            <VerticalStackLayout x:Name="ProductivityListContainer"
                                                 Margin="36,0,0,0"
                                                 Spacing="4"
                                                 IsVisible="{Binding IsProductivityExpanded}">
                                <controls:BindableLayout.ItemTemplate>
                                    <DataTemplate x:DataType="models:ToolInfo">
                                        <Frame Style="{StaticResource InteractiveButtonFrame}" HeightRequest="48">
                                            <Frame.GestureRecognizers>
                                                <TapGestureRecognizer Tapped="OnProductivitySidebarToolTapped" />
                                                <PointerGestureRecognizer PointerEntered="OnProductivitySidebarToolPointerEntered"
                                                                        PointerExited="OnProductivitySidebarToolPointerExited" />
                                            </Frame.GestureRecognizers>
                                            <Grid ColumnDefinitions="4, 28, *" ColumnSpacing="8" Padding="8,8">
                                                <!-- Active Page Indicator - Capsule Shape for tool item -->
                                                <Border x:Name="ToolIndicatorCapsule"
                                                        Grid.Column="0"
                                                        WidthRequest="4"
                                                        HeightRequest="20"
                                                        BackgroundColor="{DynamicResource PrimaryRed}"
                                                        VerticalOptions="Center"
                                                        HorizontalOptions="Center"
                                                        StrokeThickness="0"
                                                        IsVisible="{Binding IsActive}">
                                                    <Border.StrokeShape>
                                                        <RoundRectangle CornerRadius="2" />
                                                    </Border.StrokeShape>
                                                </Border>

                                                <Image Grid.Column="1"
                                                       WidthRequest="20"
                                                       HeightRequest="20"
                                                       VerticalOptions="Center">
                                                    <Image.Source>
                                                        <MultiBinding Converter="{StaticResource ThemeIconConverter}">
                                                            <Binding Path="IconPath" />
                                                            <Binding Path="BindingContext.IsDarkTheme" Source="{x:Reference MainPageRoot}" />
                                                        </MultiBinding>
                                                    </Image.Source>
                                                    <!-- Special-case: Markdown to PDF uses dedicated sidebar icons per theme -->
                                                    <Image.Triggers>
                                                        <DataTrigger TargetType="Image"
                                                                     Binding="{Binding Name}"
                                                                     Value="Markdown to PDF">
                                                            <Setter Property="Source"
                                                                    Value="{AppThemeBinding Light=md_to_pdf_lightmode_black.png, Dark=md_to_pdf_darkmode_white.png}" />
                                                        </DataTrigger>
                                                    </Image.Triggers>
                                                </Image>
                                                <Label Grid.Column="2"
                                                       VerticalOptions="Center"
                                                       TextColor="{DynamicResource TextColor}"
                                                       FontSize="14"
                                                       Text="{Binding Name}" />
                                            </Grid>
                                        </Frame>
                                    </DataTemplate>
                                </controls:BindableLayout.ItemTemplate>
                                <controls:BindableLayout.ItemsSource>
                                    <Binding Path="ProductivityTools" />
                                </controls:BindableLayout.ItemsSource>
                            </VerticalStackLayout>
                            
                        </VerticalStackLayout>
                    </VerticalStackLayout>
                </ScrollView>
                
                <!-- Settings Button (Bottom Anchored) -->
                <Border Grid.Row="1"
                        BackgroundColor="{DynamicResource SettingsBackgroundColor}"
                        StrokeThickness="0"
                        Padding="8,12"
                        IsVisible="{Binding IsSidebarCollapsed, Converter={StaticResource InvertedBoolConverter}}">
                    
                    <!-- Settings Button -->
                    <VerticalStackLayout Spacing="8">
                        <Frame Style="{StaticResource InteractiveButtonFrame}">
                            <Frame.GestureRecognizers>
                                <TapGestureRecognizer Tapped="OnSettingsClicked" />
                                <PointerGestureRecognizer PointerEntered="OnSettingsPointerEntered" 
                                                        PointerExited="OnSettingsPointerExited" />
                            </Frame.GestureRecognizers>
                            <Grid ColumnDefinitions="4, 28, *" ColumnSpacing="8" Padding="8,8">
                                <!-- Active Page Indicator -->
                                <Ellipse Grid.Column="0"
                                         WidthRequest="4"
                                         HeightRequest="4"
                                         Fill="{DynamicResource PrimaryRed}"
                                         VerticalOptions="Center"
                                         HorizontalOptions="Center"
                                         IsVisible="{Binding IsSettingsActive}" />
                                
                                <Image Grid.Column="1"
                                       WidthRequest="20"
                                       HeightRequest="20"
                                       VerticalOptions="Center">
                                    <Image.Source>
                                        <MultiBinding Converter="{StaticResource ThemeIconConverter}">
                                            <Binding Path="SettingsIconBase" />
                                            <Binding Path="IsDarkTheme" />
                                        </MultiBinding>
                                    </Image.Source>
                                </Image>
                                <Label Grid.Column="2"
                                       Text="Settings"
                                       TextColor="{DynamicResource TextColor}"
                                       VerticalOptions="Center"
                                       HorizontalOptions="Start"
                                       FontSize="14" />
                            </Grid>
                        </Frame>
                    </VerticalStackLayout>
                </Border>
                
                <!-- Settings Button for Collapsed Sidebar -->
                <Border Grid.Row="1"
                        BackgroundColor="{DynamicResource SettingsBackgroundColor}"
                        StrokeThickness="0"
                        Padding="8,12"
                        IsVisible="{Binding IsSidebarCollapsed}">
                    <Grid HeightRequest="40" WidthRequest="40" HorizontalOptions="Center">
                        <Frame Style="{StaticResource InteractiveButtonFrame}" 
                               HeightRequest="40" 
                               WidthRequest="40" 
                               CornerRadius="8">
                            <Frame.GestureRecognizers>
                                <TapGestureRecognizer Tapped="OnSettingsClicked" />
                                <PointerGestureRecognizer PointerEntered="OnSettingsPointerEntered" 
                                                        PointerExited="OnSettingsPointerExited" />
                            </Frame.GestureRecognizers>
                            <Image WidthRequest="24"
                                   HeightRequest="24"
                                   VerticalOptions="Center"
                                   HorizontalOptions="Center">
                                <Image.Source>
                                    <MultiBinding Converter="{StaticResource ThemeIconConverter}">
                                        <Binding Path="SettingsIconBase" />
                                        <Binding Path="IsDarkTheme" />
                                    </MultiBinding>
                                </Image.Source>
                            </Image>
                        </Frame>
                        
                        <!-- Active Page Indicator - Collapsed -->
                        <Ellipse WidthRequest="6"
                                 HeightRequest="6"
                                 Fill="{DynamicResource PrimaryRed}"
                                 VerticalOptions="Start"
                                 HorizontalOptions="Start"
                                 Margin="2,2,0,0"
                                 IsVisible="{Binding IsSettingsActive}" />
                    </Grid>
                </Border>
            </Grid>
        </Border>

        <!-- Main Content Area -->
        <Border Grid.Column="1"
                BackgroundColor="{DynamicResource PageBackgroundColor}"
                StrokeThickness="0">
            <!-- Content host swaps Dashboard and Tool ContentViews while keeping sidebar -->
            <ContentView x:Name="MainContentHost" />
        </Border>
    </Grid>

</ContentPage>
